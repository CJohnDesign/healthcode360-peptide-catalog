#!/usr/bin/env node

/**
 * Generate manifest of product slugs that have images.
 * Used by getProductImagePath to show illustration (vial + label) for products without images.
 *
 * Usage: node scripts/generate-image-manifest.mjs
 */

import { readdirSync, writeFileSync } from "fs";
import { join, dirname } from "path";
import { fileURLToPath } from "url";
import { PRODUCTS } from "./generate-all-product-images-v2.mjs";

const __dirname = dirname(fileURLToPath(import.meta.url));
const ROOT = join(__dirname, "..");
const PRODUCTS_DIR = join(ROOT, "public/images/products");
const OUTPUT = join(ROOT, "src/data/productImageSlugs.ts");

const productSlugs = new Set(PRODUCTS.filter((p) => !p.skip).map((p) => p.slug));
const existing = new Set(
  readdirSync(PRODUCTS_DIR)
    .filter((f) => f.endsWith(".png"))
    .map((f) => f.replace(".png", ""))
);

const withImages = [...productSlugs].filter((s) => existing.has(s));

const content = `/**
 * Product slugs that have images in public/images/products/.
 * Generated by: npm run generate:image-manifest
 * Products not in this set show the illustration (vial SVG + label) instead.
 */
export const PRODUCT_IMAGE_SLUGS = new Set(${JSON.stringify(withImages)});
`;

writeFileSync(OUTPUT, content, "utf8");
console.log(`ðŸ“¸ Updated product image manifest: ${withImages.length} products have images`);